---
title: "Geographic BIN summary"
author: "Dave Hemprich-Bennett"
date: "11/04/2022"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
# This document needs the project scripts to have been ran beforehand, to provide it with
# up-to date values
library(tidyverse)
library(here)
library(countrycode)
library(ggridges)
our_big_df <- read_csv(here('data', 'processed_data', 'bold_public_bin_matches.csv'))%>%
  mutate(geographic_region = countrycode(sourcevar = country, 
                                         origin = "country.name",
                                         destination = "region")
  ) %>%
  filter(!is.na(geographic_region), 
         !is.na(order_name))


```
This is a summary of the public data matching our BIN data that was available for download from BOLD for our projects GCEP and TMGHA, on 05/04/2022.  

There were ```r our_big_df %>% select(bin_uri) %>% distinct() %>% nrow()``` distinct BINs in our project which are also found publicly on BOLD. Those BINs are found across ```r our_big_df %>% select(country) %>% distinct() %>% nrow()``` countries in ```r our_big_df %>% select(geographic_region) %>% distinct() %>% nrow()``` geographic regions, as shown below:


```{r}
read_csv(here('results', 'public_data', 'orders_by_region.csv')) %>%
  knitr::kable(caption = 'The number of BINs found in our Ghanaian samples so far that have been found in each major geographic region.')
```
  
  
  
We could make a breakdown showing each of those ```r our_big_df %>% select(country) %>% distinct() %>% nrow()``` countries, but that would be hellish to look at, especially given the very left-skewed number of BINs found per-country:

```{r, fig.cap = "Smoothed histogram of the number of BINs found in our project found per-country in each major geographic region."}
our_big_df %>% 
  select(geographic_region, country, bin_uri) %>% 
  distinct() %>%
  group_by(country, geographic_region) %>%
  summarise(nbins = n()) %>%
  ungroup() %>%
  ggplot(., aes(x = nbins, y = geographic_region)) +
  geom_density_ridges()+
  theme_ridges() +
  theme(axis.title.y = element_blank())+
  labs(x = "Number of BINs matching our project\nfor each country that has 1 or more BINs in common with us")



```


# Countries with the greatest number of BINs in common with our project:

With that in mind, here is a taxonomic breakdown of the public BINs in common with our project, from the 20 countries which had the most BINs in common with our project:

```{r}
country_rankings <- our_big_df %>%
  select(country, bin_uri) %>%
  distinct() %>%
  group_by(country) %>%
  summarise(`Number of shared BINs` = n()) %>%
  arrange(desc(`Number of shared BINs`)) %>%
  slice(1:20) %>%
  rename(Country = country) %>%
  mutate('Ranking' = rownames(.)) %>%
  select(Ranking, Country, `Number of shared BINs`) #
  knitr::kable(country_rankings, caption = 'The top 20 countries in terms of sharing BINs with our project')
```

It's encouraging to see that several African countries are in the top 20, but noteworthy that Ghana is at number ```r country_rankings %>% filter(Country == 'Ghana') %>% pull(Ranking)``` and there are few representatives of nearby countries. Some of that will be due to varying habitat types, but it highlights just how undersampled West Africa currently is.

```{r}

topcountry_breakdown <- read_csv(here('results', 'public_data', 'orders_top_countries.csv')) %>%
  arrange(country)
country_name <- topcountry_breakdown$country[1]
coleoptera_freq <- topcountry_breakdown$Coleoptera[1]

read_csv(here('results', 'public_data', 'orders_top_countries.csv')) %>%
  arrange(country) %>%
  knitr::kable(caption = paste0('A taxonomic breakdown of the BINs found in our project that are known from elsewhere, showing the 20 countries which shared the most BINs with our project. For example, ', coleoptera_freq, ' Coleoptera BINs which we have sequenced are also known from ', country_name, '.'))
```


# Matches from Africa and the Middle East

And if we restrict the public data to just BINs from Africa and the Middle East:

```{r}



read_csv(here('results', 'public_data', 'orders_by_nearby_countries.csv')) %>%
  knitr::kable(caption = 'A taxonomic breakdown of the BINs found in our project that are known from elsewhere, showing countries within Africa and the Middle East')
```



# BIN frequency

Its also interesting to see how many countries our publicly known BINs have been documented in so far. Most of them are only known from a few countries, with a few being very widespread. (N.b taxonomic orders missing from this plot had only one or two BINs publicly available which match ones from our project so far).  
  
```{r}

country_bin_freqs <- our_big_df %>%
  select(bin_uri, order_name, country) %>%
  distinct() %>%
  group_by(bin_uri, order_name) %>%
  summarise(n_countries = n())
  
  
ggplot(country_bin_freqs, aes(x = n_countries, y = order_name)) +
  geom_density_ridges()+
  theme(axis.title.y = element_blank())+
  theme_ridges()+
  labs(x = "Number of countries BIN has been recorded in")

```


And finally, here is some basic taxonomic information from BOLD on the ten BINs found in our study so far which are commonest around the world. Duplicate rows per-BIN are because samples which have been assigned to a given BIN may have been visually assigned varying taxonomy, or to varying taxonomic levels. As I have little expertise on any of these taxa, I assume that they are either extremely cosmopolitan or invasive, and/or species complexes that aren't reliably differentiated using CO1.

```{r}
ten_commonest_bins <- our_big_df %>%
  group_by(bin_uri) %>%
  summarise(n_matches = n()) %>%
  arrange(desc(n_matches)) %>%
  slice(1:10) %>%
  pull(bin_uri)


our_big_df %>%
  filter(bin_uri %in% ten_commonest_bins) %>%
  group_by(bin_uri, order_name, family_name, genus_name) %>%
  summarise(n_worldwide_matches = n(),
            n_countries = length(unique(country))) %>%
  rename(BIN = bin_uri, `Order name` = order_name, `Family name` = family_name, `Genus name` = genus_name,
         `Number of worldwide records` = n_worldwide_matches, `Number of countries known from` = n_countries) %>%
  knitr::kable(caption = 'The taxonomy of the ten BINs we have sequenced that have the greatest number of worldwide sequences.')
  
```

